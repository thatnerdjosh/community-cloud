# Run Ansible from GitHub runner via gcloud compute ssh to control node
# Kusala Studio Community Cloud - AGPLv3
#
# Shared runner connects to the Ansible control node with gcloud compute ssh
# (no SSH keys stored in repo; IAM handles auth). Control node has ed25519 key
# for Ansible to manage other hosts.
#
# Requires: GCP_PROJECT_ID, GCP_SA_KEY. Optionally: GCP_REGION, GCP_ZONE, GCP_INSTANCE_NAME
name: Run Ansible

on:
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook path (relative to repo root)'
        required: false
        default: 'ansible/playbooks/site.yml'
  push:
    branches: [main]
    paths:
      - 'ansible/**'

jobs:
  ansible:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run Ansible on control node via gcloud compute ssh
        env:
          REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
          INSTANCE: ${{ secrets.GCP_INSTANCE_NAME || 'ansible-control' }}
          PLAYBOOK: ${{ github.event.inputs.playbook || 'ansible/playbooks/site.yml' }}
        run: |
          ZONE="${{ secrets.GCP_ZONE }}"
          if [ -z "$ZONE" ]; then
            ZONE="$(gcloud compute zones list \
              --filter="region:($REGION) AND status=UP" \
              --format="value(name)" | head -n 1)"
          fi
          if [ -z "$ZONE" ]; then
            echo "No available zone found for region $REGION"
            exit 1
          fi
          gcloud compute ssh "$INSTANCE" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --command="cd /opt/community-cloud && git pull && ansible-playbook $PLAYBOOK"
